<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Attendance Tracker</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="bg-shapes" aria-hidden="true"></div>

    <section id="pin-screen" class="auth-screen">
      <div class="card auth-card">
        <h2>Enter PIN</h2>
        <p class="muted">Access is restricted. Enter your 4-digit PIN to load cloud data.</p>
        <form id="pin-form" class="stack" novalidate onsubmit="return false;">
          <div>
            <label for="pin-input">PIN</label>
            <input
              id="pin-input"
              type="password"
              inputmode="numeric"
              pattern="[0-9]{4}"
              maxlength="4"
              required
            />
          </div>
          <button id="pin-submit" class="primary" type="button" onclick="window.pinUnlock && window.pinUnlock()">
            Unlock
          </button>
        </form>
        <p id="pin-error" class="muted error"></p>
      </div>
    </section>

    <div id="app" class="app" hidden>
      <header class="app-header">
        <div class="brand">
          <div class="logo">AT</div>
          <div class="brand-text">
            <h1>Attendance Tracker</h1>
            <p>Editable, transparent, and built for quick decisions.</p>
          </div>
        </div>
        <div class="org">
          <label for="org-name">Organization</label>
          <input id="org-name" type="text" placeholder="Add your organization name" />
        </div>
      </header>

      <nav class="tabs" aria-label="Primary">
        <button class="tab active" data-tab="dashboard">Dashboard</button>
        <button class="tab" data-tab="person-hub">Person Hub</button>
        <button class="tab" data-tab="person-edit">Update Info</button>
        <button class="tab" data-tab="points">Point System</button>
        <button class="tab" data-tab="admin">Admin</button>
      </nav>

      <main>
      <section id="dashboard" class="tab-panel active">
        <div class="grid two">
          <article class="card">
            <h2>Today at a Glance</h2>
            <div class="stats">
              <div>
                <p class="stat-label">Total People</p>
                <p class="stat-value" id="stat-people">0</p>
              </div>
              <div>
                <p class="stat-label">Attendance Entries</p>
                <p class="stat-value" id="stat-entries">0</p>
              </div>
              <div>
                <p class="stat-label">Average Points</p>
                <p class="stat-value" id="stat-average">0</p>
              </div>
            </div>
            <div class="divider"></div>
            <div class="row">
              <div>
                <label for="filter-from">From</label>
                <input id="filter-from" type="date" />
              </div>
              <div>
                <label for="filter-to">To</label>
                <input id="filter-to" type="date" />
              </div>
              <button id="apply-filter" class="secondary">Apply Filter</button>
              <button id="clear-filter" class="ghost">Clear</button>
            </div>
          </article>
          <article class="card">
            <h2>Point System Snapshot</h2>
            <div id="points-preview" class="tag-grid"></div>
            <p class="muted">Edit point values in the Point System tab. Changes apply instantly.</p>
          </article>
        </div>
        <article class="card">
          <div class="row between">
            <h2>Yearly Attendance Map</h2>
            <div class="muted">All people combined</div>
          </div>
          <div id="dashboard-calendar" class="year-grid"></div>
        </article>
      </section>

      <section id="person-hub" class="tab-panel">
        <article class="card">
          <div class="row between">
            <div>
              <h2>Person Hub</h2>
              <p class="muted">Choose a person to view and edit everything in one place.</p>
            </div>
            <div class="row">
              <label for="person-select">Select Person</label>
              <select id="person-select"></select>
            </div>
          </div>
        </article>

        <div class="grid two">
          <article class="card" id="person-details"></article>
          <article class="card" id="person-attendance"></article>
        </div>
        <article class="card">
          <div class="row between">
            <h2>Yearly Calendar</h2>
            <div class="muted">Click a date to view or edit details.</div>
          </div>
          <div id="person-calendar" class="year-grid"></div>
        </article>
      </section>

      <section id="person-edit" class="tab-panel">
        <article class="card">
          <div class="row between">
            <div>
              <h2>Update Info</h2>
              <p class="muted">Edit all details for the selected person.</p>
            </div>
            <div class="row">
              <button id="back-to-person" class="ghost">Back to Person Hub</button>
            </div>
          </div>
          <div id="edit-content" class="stack"></div>
        </article>
      </section>

      <section id="points" class="tab-panel">
        <article class="card">
          <div class="row between">
            <div>
              <h2>Point System</h2>
              <p class="muted">Every rule is editable. Use labels your team already understands.</p>
            </div>
            <button id="add-rule" class="secondary">Add Rule</button>
          </div>
          <div id="points-table"></div>
        </article>
      </section>

      <section id="admin" class="tab-panel">
        <div class="grid two">
          <article class="card">
            <h2>People Management</h2>
            <form id="add-person-form" class="stack">
              <div class="row">
                <div>
                  <label for="new-name">Name</label>
                  <input id="new-name" type="text" required />
                </div>
                <div>
                  <label for="new-role">Role</label>
                  <input id="new-role" type="text" />
                </div>
              </div>
              <div class="row">
                <div>
                  <label for="new-email">Email</label>
                  <input id="new-email" type="email" />
                </div>
                <div>
                  <label for="new-phone">Phone</label>
                  <input id="new-phone" type="text" />
                </div>
              </div>
              <div>
                <label for="new-notes">Notes</label>
                <textarea id="new-notes" rows="3"></textarea>
              </div>
              <button type="submit" class="primary">Add Person</button>
            </form>
          </article>

          <article class="card">
            <h2>Import / Export</h2>
            <div class="stack">
              <button id="export-data" class="secondary">Export Data (JSON)</button>
              <label class="file-label" for="import-data">Import Data (JSON)</label>
              <input id="import-data" type="file" accept="application/json" />
              <button id="reset-data" class="ghost">Reset to Defaults</button>
            </div>
            <p class="muted">Use export/import to back up data or move it to another device.</p>
          </article>
        </div>

        <article class="card">
          <h2>All People</h2>
          <div id="people-table"></div>
        </article>
      </section>
      </main>

      <div id="day-modal" class="modal-overlay" hidden>
        <div class="modal">
          <button id="day-modal-close" class="modal-close" aria-label="Close">×</button>
          <div id="day-modal-content" class="stack"></div>
        </div>
      </div>

      <footer class="app-footer">
        <p>Built for editable attendance tracking. Data is stored in the cloud.</p>
      </footer>
    </div>

    <script>
      window.__appReady = false;
      window.__appLoadError = "";
      window.setPinError = function (message) {
        var target = document.getElementById("pin-error");
        var text = message || "";
        if (target) target.textContent = text;
        window.__appLoadError = text;
      };
      window.pinUnlock = function () {
        window.setPinError("App is still loading. Please wait a moment.");
      };
      window.onerror = function (message, source, lineno, colno, error) {
        var detail = message ? String(message) : "Unknown error";
        if (source) {
          var shortSource = String(source).split("/").pop();
          detail += " (" + shortSource + ":" + lineno + ")";
        }
        window.setPinError("App error: " + detail);
        return false;
      };
      window.addEventListener("unhandledrejection", function (event) {
        var reason = event && event.reason ? event.reason : "Unknown promise error";
        window.setPinError("App error: " + reason);
      });
      window.addEventListener("load", function () {
        setTimeout(function () {
          if (!window.__appReady && !window.__appLoadError) {
            window.setPinError(
              "App failed to load. Try Chrome/Edge or refresh."
            );
          }
        }, 1500);
      });
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"
      onerror="window.setPinError('Supabase library blocked. Please check your network.');"
    ></script>
    <script>
const SUPABASE_URL = "https://ryeidiawdqejwpvzxhnp.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_44bO8u3pthKzdzXLy1298Q_7Xg8pYwg";

const ACCESS_PIN = "1988";
const PIN_SESSION_KEY = "attendance-tracker-pin-ok";
const CLOUD_KEY = "attendance-tracker-main";

function getSessionFlag(key) {
  try {
    return sessionStorage.getItem(key) === "true";
  } catch (error) {
    return false;
  }
}

function setSessionFlag(key, value) {
  try {
    sessionStorage.setItem(key, value ? "true" : "false");
  } catch (error) {
    // Ignore storage errors (e.g. blocked storage in some environments).
  }
}

const MONTH_NAMES = [
  "January",
  "February",
  "March",
  "April",
  "May",
  "June",
  "July",
  "August",
  "September",
  "October",
  "November",
  "December",
];
const WEEKDAYS = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

const supabase =
  window.supabase && typeof window.supabase.createClient === "function"
    ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          persistSession: false,
          autoRefreshToken: false,
          detectSessionInUrl: false,
        },
      })
    : null;

const defaultData = () => ({
  settings: {
    orgName: "",
    filterFrom: "",
    filterTo: "",
  },
  pointRules: [
    { id: "rule-present", label: "Present", code: "P", points: 2, color: "#0f9f93" },
    { id: "rule-late", label: "Late", code: "L", points: 0, color: "#f6b73c" },
    { id: "rule-absent", label: "Absent", code: "A", points: -2, color: "#de5f3a" },
    { id: "rule-excused", label: "Excused", code: "E", points: 0, color: "#4f7cac" },
  ],
  people: [
    {
      id: "person-1",
      name: "Alex Rivera",
      role: "Team Lead",
      email: "alex@example.com",
      phone: "",
      status: "Active",
      startDate: "",
      tags: "",
      notes: "",
      adjustment: 0,
      attendance: [
        {
          id: "entry-1",
          date: new Date().toISOString().slice(0, 10),
          ruleId: "rule-present",
          pointsOverride: null,
          notes: "",
        },
      ],
    },
  ],
});

const state = {
  data: defaultData(),
  currentPersonId: null,
  ready: false,
};

let saveTimer = null;

function uid(prefix) {
  return `${prefix}-${Math.random().toString(36).slice(2, 10)}`;
}

function pad(value) {
  return String(value).padStart(2, "0");
}

function escapeHtml(value) {
  return String(value)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/\"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function getRuleById(ruleId) {
  return state.data.pointRules.find((rule) => rule.id === ruleId) || null;
}

function entryPoints(entry) {
  if (entry.pointsOverride !== null && entry.pointsOverride !== "") {
    const parsed = Number(entry.pointsOverride);
    if (!Number.isNaN(parsed)) return parsed;
  }
  const rule = getRuleById(entry.ruleId);
  return rule ? Number(rule.points) : 0;
}

function personTotalPoints(person) {
  const attendancePoints = person.attendance.reduce((sum, entry) => sum + entryPoints(entry), 0);
  return attendancePoints + Number(person.adjustment || 0);
}

function getFilteredEntries() {
  const from = state.data.settings.filterFrom;
  const to = state.data.settings.filterTo;
  const fromDate = from ? new Date(from) : null;
  const toDate = to ? new Date(to) : null;

  const entries = [];
  state.data.people.forEach((person) => {
    person.attendance.forEach((entry) => {
      const entryDate = entry.date ? new Date(entry.date) : null;
      if (fromDate && entryDate && entryDate < fromDate) return;
      if (toDate && entryDate && entryDate > toDate) return;
      entries.push({
        personId: person.id,
        personName: person.name,
        entry,
      });
    });
  });
  return entries;
}

function switchTab(tabId) {
  document.querySelectorAll(".tab").forEach((tab) => {
    tab.classList.toggle("active", tab.dataset.tab === tabId);
  });
  document.querySelectorAll(".tab-panel").forEach((panel) => {
    panel.classList.toggle("active", panel.id === tabId);
  });
}

function renderDashboard() {
  const peopleCount = state.data.people.length;
  const entries = getFilteredEntries();
  const totalEntries = entries.length;
  const totalPoints = state.data.people.reduce((sum, person) => sum + personTotalPoints(person), 0);
  const avgPoints = peopleCount ? (totalPoints / peopleCount).toFixed(1) : "0";

  document.getElementById("stat-people").textContent = peopleCount;
  document.getElementById("stat-entries").textContent = totalEntries;
  document.getElementById("stat-average").textContent = avgPoints;

  const pointsPreview = document.getElementById("points-preview");
  pointsPreview.innerHTML = "";
  state.data.pointRules.forEach((rule) => {
    const tag = document.createElement("div");
    tag.className = "tag";
    tag.textContent = `${rule.label}: ${rule.points}`;
    tag.style.background = `${rule.color}22`;
    tag.style.color = rule.color;
    pointsPreview.appendChild(tag);
  });

  renderDashboardCalendar();
}

function renderPersonSelect() {
  const select = document.getElementById("person-select");
  select.innerHTML = "";

  if (state.data.people.length === 0) {
    const option = document.createElement("option");
    option.textContent = "No people available";
    option.value = "";
    select.appendChild(option);
    return;
  }

  state.data.people.forEach((person) => {
    const option = document.createElement("option");
    option.value = person.id;
    option.textContent = person.name;
    select.appendChild(option);
  });

  if (!state.currentPersonId || !state.data.people.some((p) => p.id === state.currentPersonId)) {
    state.currentPersonId = state.data.people[0].id;
  }
  select.value = state.currentPersonId;
}

function renderPersonDetails() {
  const container = document.getElementById("person-details");
  const person = state.data.people.find((p) => p.id === state.currentPersonId);

  if (!person) {
    container.innerHTML = '<p class="muted">Select a person to view details.</p>';
    return;
  }

  container.innerHTML = `
    <div class="row between">
      <h2>${person.name}</h2>
      <div class="row">
        <button id="update-person" class="secondary">Update Info</button>
        <button id="remove-person" class="ghost">Remove Person</button>
      </div>
    </div>
    <div class="stats">
      <div>
        <p class="stat-label">Total Points</p>
        <p class="stat-value">${personTotalPoints(person)}</p>
      </div>
      <div>
        <p class="stat-label">Entries</p>
        <p class="stat-value">${person.attendance.length}</p>
      </div>
      <div>
        <p class="stat-label">Status</p>
        <p class="stat-value">${person.status || "-"}</p>
      </div>
    </div>
    <div class="divider"></div>
    <div class="info-grid">
      <div class="info-item">
        <span>Role</span>
        <p>${escapeHtml(person.role || "-")}</p>
      </div>
      <div class="info-item">
        <span>Email</span>
        <p>${escapeHtml(person.email || "-")}</p>
      </div>
      <div class="info-item">
        <span>Phone</span>
        <p>${escapeHtml(person.phone || "-")}</p>
      </div>
      <div class="info-item">
        <span>Start Date</span>
        <p>${escapeHtml(person.startDate || "-")}</p>
      </div>
      <div class="info-item">
        <span>Tags</span>
        <p>${escapeHtml(person.tags || "-")}</p>
      </div>
      <div class="info-item">
        <span>Manual Adjustment</span>
        <p>${person.adjustment || 0}</p>
      </div>
      <div class="info-item full">
        <span>Notes</span>
        <p>${escapeHtml(person.notes || "-")}</p>
      </div>
    </div>
  `;

  container.querySelector("#update-person").addEventListener("click", () => {
    switchTab("person-edit");
    renderPersonEdit();
  });

  container.querySelector("#remove-person").addEventListener("click", () => {
    if (!confirm(`Remove ${person.name}? This cannot be undone.`)) return;
    state.data.people = state.data.people.filter((p) => p.id !== person.id);
    state.currentPersonId = state.data.people.length ? state.data.people[0].id : null;
    saveData();
    renderAll();
    switchTab("person-hub");
  });
}

function renderPersonAttendance() {
  const container = document.getElementById("person-attendance");
  const person = state.data.people.find((p) => p.id === state.currentPersonId);

  if (!person) {
    container.innerHTML = "";
    return;
  }

  container.innerHTML = `
    <div class="row between">
      <h2>Attendance & Points</h2>
      <div class="muted">Auto-calculates from the point system.</div>
    </div>
    <form id="add-entry-form" class="stack">
      <div class="row">
        <div>
          <label for="entry-date">Date</label>
          <input id="entry-date" type="date" required />
        </div>
        <div>
          <label for="entry-rule">Status</label>
          <select id="entry-rule"></select>
        </div>
        <div>
          <label for="entry-points">Points Override</label>
          <input id="entry-points" type="number" placeholder="Auto" />
        </div>
      </div>
      <div>
        <label for="entry-notes">Notes</label>
        <input id="entry-notes" type="text" placeholder="Optional" />
      </div>
      <button class="secondary" type="submit">Add Entry</button>
    </form>
    <div class="divider"></div>
    <div id="attendance-list"></div>
  `;

  const ruleSelect = container.querySelector("#entry-rule");
  state.data.pointRules.forEach((rule) => {
    const option = document.createElement("option");
    option.value = rule.id;
    option.textContent = `${rule.label} (${rule.points})`;
    ruleSelect.appendChild(option);
  });

  const form = container.querySelector("#add-entry-form");
  form.addEventListener("submit", (event) => {
    event.preventDefault();
    const date = container.querySelector("#entry-date").value;
    const ruleId = ruleSelect.value;
    const pointsOverrideRaw = container.querySelector("#entry-points").value;
    const notes = container.querySelector("#entry-notes").value;

    person.attendance.unshift({
      id: uid("entry"),
      date,
      ruleId,
      pointsOverride: pointsOverrideRaw === "" ? null : Number(pointsOverrideRaw),
      notes,
    });
    saveData();
    renderAll();
  });

  const list = container.querySelector("#attendance-list");
  if (person.attendance.length === 0) {
    list.innerHTML = '<p class="muted">No attendance entries yet.</p>';
    return;
  }

  person.attendance.forEach((entry) => {
    const row = document.createElement("div");
    row.className = "table-row";
    row.innerHTML = `
      <div>
        <label>Date</label>
        <input type="date" value="${escapeHtml(entry.date || "")}" data-field="date" />
      </div>
      <div>
        <label>Status</label>
        <select data-field="rule"></select>
      </div>
      <div>
        <label>Points</label>
        <input
          type="number"
          value="${entry.pointsOverride === null || entry.pointsOverride === undefined ? "" : entry.pointsOverride}"
          placeholder="Auto"
          data-field="points"
        />
      </div>
      <div>
        <label>Notes</label>
        <input type="text" value="${escapeHtml(entry.notes || "")}" data-field="notes" />
      </div>
      <div class="actions">
        <button class="ghost" data-action="remove">Remove</button>
      </div>
    `;

    const select = row.querySelector("select");
    state.data.pointRules.forEach((rule) => {
      const option = document.createElement("option");
      option.value = rule.id;
      option.textContent = rule.label;
      if (rule.id === entry.ruleId) option.selected = true;
      select.appendChild(option);
    });

    row.querySelectorAll("input, select").forEach((input) => {
      input.addEventListener("change", (event) => {
        const field = event.target.dataset.field;
        if (field === "date") entry.date = event.target.value;
        if (field === "rule") entry.ruleId = event.target.value;
        if (field === "points") {
          const value = event.target.value;
          entry.pointsOverride = value === "" ? null : Number(value);
        }
        if (field === "notes") entry.notes = event.target.value;
        saveData();
        renderAll();
      });
    });

    row.querySelector("[data-action='remove']").addEventListener("click", () => {
      person.attendance = person.attendance.filter((item) => item.id !== entry.id);
      saveData();
      renderAll();
    });

    list.appendChild(row);
  });
}

function renderPointsTable() {
  const container = document.getElementById("points-table");
  container.innerHTML = "";

  state.data.pointRules.forEach((rule) => {
    const row = document.createElement("div");
    row.className = "table-row";
    row.innerHTML = `
      <div>
        <label>Label</label>
        <input type="text" value="${escapeHtml(rule.label)}" data-field="label" />
      </div>
      <div>
        <label>Code</label>
        <input type="text" value="${escapeHtml(rule.code)}" data-field="code" />
      </div>
      <div>
        <label>Points</label>
        <input type="number" value="${rule.points}" data-field="points" />
      </div>
      <div>
        <label>Color</label>
        <input type="color" value="${rule.color}" data-field="color" />
      </div>
      <div class="actions">
        <button class="ghost" data-action="remove">Remove</button>
      </div>
    `;

    row.querySelectorAll("input").forEach((input) => {
      input.addEventListener("change", (event) => {
        const field = event.target.dataset.field;
        if (field === "label") rule.label = event.target.value;
        if (field === "code") rule.code = event.target.value;
        if (field === "points") rule.points = Number(event.target.value);
        if (field === "color") rule.color = event.target.value;
        saveData();
        renderAll();
      });
    });

    row.querySelector("[data-action='remove']").addEventListener("click", () => {
      if (state.data.pointRules.length <= 1) {
        alert("At least one point rule is required.");
        return;
      }
      if (!confirm(`Remove point rule "${rule.label}"?`)) return;
      const remaining = state.data.pointRules.filter((r) => r.id !== rule.id);
      const fallback = remaining[0];
      state.data.people.forEach((person) => {
        person.attendance.forEach((entry) => {
          if (entry.ruleId === rule.id && fallback) entry.ruleId = fallback.id;
        });
      });
      state.data.pointRules = remaining;
      saveData();
      renderAll();
    });

    container.appendChild(row);
  });
}

function renderPeopleTable() {
  const container = document.getElementById("people-table");
  container.innerHTML = "";

  if (state.data.people.length === 0) {
    container.innerHTML = '<p class="muted">No people yet. Use the form above to add someone.</p>';
    return;
  }

  state.data.people.forEach((person) => {
    const row = document.createElement("div");
    row.className = "table-row";
    row.innerHTML = `
      <div>
        <label>Name</label>
        <input type="text" value="${escapeHtml(person.name)}" data-field="name" />
      </div>
      <div>
        <label>Role</label>
        <input type="text" value="${escapeHtml(person.role || "")}" data-field="role" />
      </div>
      <div>
        <label>Email</label>
        <input type="email" value="${escapeHtml(person.email || "")}" data-field="email" />
      </div>
      <div>
        <label>Phone</label>
        <input type="text" value="${escapeHtml(person.phone || "")}" data-field="phone" />
      </div>
      <div>
        <label>Points</label>
        <input type="number" value="${personTotalPoints(person)}" disabled />
      </div>
      <div class="actions">
        <button class="ghost" data-action="open">Open</button>
        <button class="ghost" data-action="remove">Remove</button>
      </div>
    `;

    row.querySelectorAll("input").forEach((input) => {
      input.addEventListener("change", (event) => {
        const field = event.target.dataset.field;
        if (!field) return;
        person[field] = event.target.value;
        saveData();
        renderAll();
      });
    });

    row.querySelector("[data-action='open']").addEventListener("click", () => {
      state.currentPersonId = person.id;
      saveData();
      renderAll();
      switchTab("person-hub");
    });

    row.querySelector("[data-action='remove']").addEventListener("click", () => {
      if (!confirm(`Remove ${person.name}?`)) return;
      state.data.people = state.data.people.filter((p) => p.id !== person.id);
      if (state.currentPersonId === person.id) {
        state.currentPersonId = state.data.people[0] ? state.data.people[0].id : null;
      }
      saveData();
      renderAll();
    });

    container.appendChild(row);
  });
}

function bindInput(id, handler) {
  const input = document.getElementById(id);
  if (!input) return;
  input.addEventListener("change", (event) => {
    handler(event.target.value);
    saveData();
    renderAll();
  });
}

function bindTextarea(id, handler) {
  const input = document.getElementById(id);
  if (!input) return;
  input.addEventListener("change", (event) => {
    handler(event.target.value);
    saveData();
    renderAll();
  });
}

function bindScopedInput(container, selector, handler) {
  const input = container.querySelector(selector);
  if (!input) return;
  input.addEventListener("change", (event) => {
    handler(event.target.value);
    saveData();
    renderAll();
  });
}

function bindScopedTextarea(container, selector, handler) {
  const input = container.querySelector(selector);
  if (!input) return;
  input.addEventListener("change", (event) => {
    handler(event.target.value);
    saveData();
    renderAll();
  });
}

function renderYearCalendar(container, year, getMeta) {
  if (!container) return;
  container.innerHTML = "";

  for (let monthIndex = 0; monthIndex < 12; monthIndex += 1) {
    const monthCard = document.createElement("div");
    monthCard.className = "month-card";

    const header = document.createElement("div");
    header.className = "month-header";
    header.innerHTML = `<span>${MONTH_NAMES[monthIndex]}</span><span>${year}</span>`;

    const grid = document.createElement("div");
    grid.className = "month-grid";

    WEEKDAYS.forEach((day) => {
      const label = document.createElement("div");
      label.className = "weekday";
      label.textContent = day;
      grid.appendChild(label);
    });

    const firstDay = new Date(year, monthIndex, 1).getDay();
    const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();

    for (let i = 0; i < firstDay; i += 1) {
      const empty = document.createElement("div");
      empty.className = "day-cell empty";
      grid.appendChild(empty);
    }

    for (let day = 1; day <= daysInMonth; day += 1) {
      const dateStr = `${year}-${pad(monthIndex + 1)}-${pad(day)}`;
      const meta = getMeta(dateStr, monthIndex, day) || {};
      const cell = document.createElement("div");
      cell.className = "day-cell";
      cell.textContent = day;

      if (meta.color) {
        cell.style.background = meta.color;
      }
      if (meta.textColor) {
        cell.style.color = meta.textColor;
      }
      if (meta.hasEntry) {
        cell.classList.add("has-entry");
      }
      if (meta.onClick) {
        cell.addEventListener("click", meta.onClick);
      }

      grid.appendChild(cell);
    }

    monthCard.appendChild(header);
    monthCard.appendChild(grid);
    container.appendChild(monthCard);
  }
}

function renderPersonCalendar() {
  const container = document.getElementById("person-calendar");
  const person = state.data.people.find((p) => p.id === state.currentPersonId);

  if (!person) {
    if (container) container.innerHTML = '<p class="muted">Select a person to view the calendar.</p>';
    return;
  }

  const entryMap = new Map();
  person.attendance.forEach((entry) => {
    if (entry.date) entryMap.set(entry.date, entry);
  });

  const year = new Date().getFullYear();
  renderYearCalendar(container, year, (dateStr) => {
    const entry = entryMap.get(dateStr) || null;
    const rule = entry ? getRuleById(entry.ruleId) : null;
    const color = entry ? (rule && rule.color ? rule.color : "#5a5a5a") : null;
    return {
      color,
      textColor: entry ? "#fff" : null,
      hasEntry: Boolean(entry),
      onClick: () => openPersonDayModal(person, dateStr, entry),
    };
  });
}

function renderDashboardCalendar() {
  const container = document.getElementById("dashboard-calendar");
  if (!container) return;

  const entryMap = new Map();
  state.data.people.forEach((person) => {
    person.attendance.forEach((entry) => {
      if (!entry.date) return;
      const list = entryMap.get(entry.date) || [];
      list.push({
        personName: person.name,
        entry,
        rule: getRuleById(entry.ruleId),
      });
      entryMap.set(entry.date, list);
    });
  });

  const counts = Array.from(entryMap.values()).map((list) => list.length);
  const maxCount = counts.length ? Math.max(...counts) : 0;
  const year = new Date().getFullYear();

  renderYearCalendar(container, year, (dateStr) => {
    const entries = entryMap.get(dateStr) || [];
    let color = null;
    if (entries.length) {
      const intensity = maxCount ? 0.2 + (entries.length / maxCount) * 0.7 : 0.4;
      color = `rgba(15, 159, 147, ${intensity.toFixed(2)})`;
    }
    return {
      color,
      textColor: entries.length ? "#fff" : null,
      hasEntry: entries.length > 0,
      onClick: () => openDashboardDayModal(dateStr, entries),
    };
  });
}

function openDayModal(contentHtml) {
  const overlay = document.getElementById("day-modal");
  const content = document.getElementById("day-modal-content");
  content.innerHTML = contentHtml;
  overlay.hidden = false;
}

function closeDayModal() {
  const overlay = document.getElementById("day-modal");
  overlay.hidden = true;
}

function openPersonDayModal(person, dateStr, entry) {
  const ruleOptions = state.data.pointRules
    .map((rule) => {
      const selected = entry && entry.ruleId === rule.id ? "selected" : "";
      return `<option value="${rule.id}" ${selected}>${rule.label} (${rule.points})</option>`;
    })
    .join("");

  const pointsValue =
    entry && entry.pointsOverride !== null && entry.pointsOverride !== undefined ? entry.pointsOverride : "";
  const notesValue = entry && entry.notes ? entry.notes : "";

  openDayModal(`
    <h3>${person.name} · ${dateStr}</h3>
    <form id="day-entry-form" class="stack">
      <div>
        <label for="modal-rule">Status</label>
        <select id="modal-rule">${ruleOptions}</select>
      </div>
      <div>
        <label for="modal-points">Points Override</label>
        <input id="modal-points" type="number" value="${pointsValue}" placeholder="Auto" />
      </div>
      <div>
        <label for="modal-notes">Notes</label>
        <textarea id="modal-notes" rows="3">${escapeHtml(notesValue)}</textarea>
      </div>
      <div class="row">
        <button class="primary" type="submit">Save</button>
        ${entry ? '<button id="modal-remove" class="ghost" type="button">Remove Entry</button>' : ""}
      </div>
    </form>
  `);

  const form = document.getElementById("day-entry-form");
  form.addEventListener("submit", (event) => {
    event.preventDefault();
    const ruleId = document.getElementById("modal-rule").value;
    const pointsOverrideRaw = document.getElementById("modal-points").value;
    const notes = document.getElementById("modal-notes").value;

    if (entry) {
      entry.ruleId = ruleId;
      entry.pointsOverride = pointsOverrideRaw === "" ? null : Number(pointsOverrideRaw);
      entry.notes = notes;
    } else {
      person.attendance.unshift({
        id: uid("entry"),
        date: dateStr,
        ruleId,
        pointsOverride: pointsOverrideRaw === "" ? null : Number(pointsOverrideRaw),
        notes,
      });
    }
    saveData();
    renderAll();
    closeDayModal();
  });

  const removeButton = document.getElementById("modal-remove");
  if (removeButton && entry) {
    removeButton.addEventListener("click", () => {
      person.attendance = person.attendance.filter((item) => item.id !== entry.id);
      saveData();
      renderAll();
      closeDayModal();
    });
  }
}

function openDashboardDayModal(dateStr, entries) {
  if (!entries.length) {
    openDayModal(`
      <h3>${dateStr}</h3>
      <p class="muted">No attendance entries recorded.</p>
    `);
    return;
  }

  const rows = entries
    .map((item) => {
      const ruleLabel = item.rule ? item.rule.label : "Unknown";
      const points = entryPoints(item.entry);
      return `
        <div class="table-row">
          <div>
            <label>Person</label>
            <div>${escapeHtml(item.personName)}</div>
          </div>
          <div>
            <label>Status</label>
            <div>${escapeHtml(ruleLabel)}</div>
          </div>
          <div>
            <label>Points</label>
            <div>${points}</div>
          </div>
          <div>
            <label>Notes</label>
            <div>${escapeHtml(item.entry.notes || "-")}</div>
          </div>
        </div>
      `;
    })
    .join("");

  openDayModal(`
    <h3>${dateStr} · All People</h3>
    <div class="stack">${rows}</div>
  `);
}

function renderPersonEdit() {
  const content = document.getElementById("edit-content");
  const person = state.data.people.find((p) => p.id === state.currentPersonId);

  if (!content) return;
  if (!person) {
    content.innerHTML = '<p class="muted">Select a person in Person Hub first.</p>';
    return;
  }

  content.innerHTML = `
    <p class="muted">Changes save automatically.</p>
    <div class="row">
      <div>
        <label for="edit-name">Name</label>
        <input id="edit-name" type="text" value="${escapeHtml(person.name)}" />
      </div>
      <div>
        <label for="edit-role">Role</label>
        <input id="edit-role" type="text" value="${escapeHtml(person.role || "")}" />
      </div>
    </div>
    <div class="row">
      <div>
        <label for="edit-email">Email</label>
        <input id="edit-email" type="email" value="${escapeHtml(person.email || "")}" />
      </div>
      <div>
        <label for="edit-phone">Phone</label>
        <input id="edit-phone" type="text" value="${escapeHtml(person.phone || "")}" />
      </div>
    </div>
    <div class="row">
      <div>
        <label for="edit-status">Status</label>
        <input id="edit-status" type="text" value="${escapeHtml(person.status || "")}" />
      </div>
      <div>
        <label for="edit-start">Start Date</label>
        <input id="edit-start" type="date" value="${escapeHtml(person.startDate || "")}" />
      </div>
    </div>
    <div class="row">
      <div>
        <label for="edit-tags">Tags</label>
        <input id="edit-tags" type="text" value="${escapeHtml(person.tags || "")}" />
      </div>
      <div>
        <label for="edit-adjust">Manual Adjustment</label>
        <input id="edit-adjust" type="number" value="${person.adjustment || 0}" />
      </div>
    </div>
    <div>
      <label for="edit-notes">Notes</label>
      <textarea id="edit-notes" rows="4">${escapeHtml(person.notes || "")}</textarea>
    </div>
  `;

  bindScopedInput(content, "#edit-name", (value) => (person.name = value));
  bindScopedInput(content, "#edit-role", (value) => (person.role = value));
  bindScopedInput(content, "#edit-email", (value) => (person.email = value));
  bindScopedInput(content, "#edit-phone", (value) => (person.phone = value));
  bindScopedInput(content, "#edit-status", (value) => (person.status = value));
  bindScopedInput(content, "#edit-start", (value) => (person.startDate = value));
  bindScopedInput(content, "#edit-tags", (value) => (person.tags = value));
  bindScopedInput(content, "#edit-adjust", (value) => (person.adjustment = Number(value) || 0));
  bindScopedTextarea(content, "#edit-notes", (value) => (person.notes = value));
}

function renderAll() {
  document.getElementById("org-name").value = state.data.settings.orgName || "";
  document.getElementById("filter-from").value = state.data.settings.filterFrom || "";
  document.getElementById("filter-to").value = state.data.settings.filterTo || "";

  renderDashboard();
  renderPersonSelect();
  renderPersonDetails();
  renderPersonAttendance();
  renderPointsTable();
  renderPeopleTable();
  renderPersonCalendar();
  renderPersonEdit();
}

function setPinError(message) {
  const target = document.getElementById("pin-error");
  if (target) target.textContent = message || "";
}

function setLockState(isLocked) {
  const pinScreen = document.getElementById("pin-screen");
  const app = document.getElementById("app");
  if (isLocked) {
    pinScreen.style.display = "grid";
    app.hidden = true;
  } else {
    pinScreen.style.display = "none";
    app.hidden = false;
  }
}

async function loadRemoteData() {
  const { data, error } = await supabase
    .from("app_state")
    .select("data")
    .eq("key", CLOUD_KEY)
    .maybeSingle();

  if (error) {
    console.error(error);
    return null;
  }

  if (!data) {
    const payload = defaultData();
    const { error: insertError } = await supabase.from("app_state").upsert({
      key: CLOUD_KEY,
      data: payload,
      updated_at: new Date().toISOString(),
    });
    if (insertError) console.error(insertError);
    return payload;
  }

  return data.data || defaultData();
}

function saveData() {
  if (!state.ready) return;
  if (saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(persistData, 500);
}

async function persistData() {
  if (!state.ready) return;
  const payload = {
    key: CLOUD_KEY,
    data: state.data,
    updated_at: new Date().toISOString(),
  };
  const { error } = await supabase.from("app_state").upsert(payload);
  if (error) console.error(error);
}

async function unlockWithPin(pinInput) {
  if (pinInput !== ACCESS_PIN) {
    setPinError("Incorrect PIN.");
    return false;
  }
  if (!supabase) {
    setPinError("Supabase client failed to initialize.");
    return false;
  }

  const remoteData = await loadRemoteData();
  if (!remoteData) {
    setPinError("Cloud data unavailable. Check Supabase setup.");
    return false;
  }

  setPinError("");
  setSessionFlag(PIN_SESSION_KEY, true);

  state.data = remoteData;
  state.ready = true;
  setLockState(false);
  renderAll();
  return true;
}

function init() {
  const pinInput = document.getElementById("pin-input");
  const pinSubmit = document.getElementById("pin-submit");
  const pinForm = document.getElementById("pin-form");
  const dayModal = document.getElementById("day-modal");
  const dayModalClose = document.getElementById("day-modal-close");
  const backToPerson = document.getElementById("back-to-person");

  const attemptUnlock = async () => {
    pinSubmit.disabled = true;
    const value = pinInput.value.trim();
    pinInput.value = "";
    const ok = await unlockWithPin(value);
    if (!ok) pinInput.focus();
    pinSubmit.disabled = false;
  };

  window.pinUnlock = attemptUnlock;

  pinSubmit.addEventListener("click", attemptUnlock);
  pinInput.addEventListener("keydown", (event) => {
    if (event.key === "Enter") {
      event.preventDefault();
      attemptUnlock();
    }
  });
  if (pinForm) {
    pinForm.addEventListener("submit", (event) => {
      event.preventDefault();
      attemptUnlock();
    });
  }

  dayModalClose.addEventListener("click", closeDayModal);
  dayModal.addEventListener("click", (event) => {
    if (event.target === dayModal) closeDayModal();
  });

  if (backToPerson) {
    backToPerson.addEventListener("click", () => {
      switchTab("person-hub");
    });
  }

  document.querySelectorAll(".tab").forEach((tab) => {
    tab.addEventListener("click", () => switchTab(tab.dataset.tab));
  });

  document.getElementById("org-name").addEventListener("change", (event) => {
    state.data.settings.orgName = event.target.value;
    saveData();
  });

  document.getElementById("person-select").addEventListener("change", (event) => {
    state.currentPersonId = event.target.value;
    renderAll();
  });

  document.getElementById("add-rule").addEventListener("click", () => {
    state.data.pointRules.push({
      id: uid("rule"),
      label: "New Rule",
      code: "N",
      points: 0,
      color: "#0f9f93",
    });
    saveData();
    renderAll();
  });

  document.getElementById("add-person-form").addEventListener("submit", (event) => {
    event.preventDefault();
    const nameInput = document.getElementById("new-name");
    const roleInput = document.getElementById("new-role");
    const emailInput = document.getElementById("new-email");
    const phoneInput = document.getElementById("new-phone");
    const notesInput = document.getElementById("new-notes");

    const person = {
      id: uid("person"),
      name: nameInput.value.trim(),
      role: roleInput.value.trim(),
      email: emailInput.value.trim(),
      phone: phoneInput.value.trim(),
      status: "Active",
      startDate: "",
      tags: "",
      notes: notesInput.value.trim(),
      adjustment: 0,
      attendance: [],
    };

    if (!person.name) return;
    state.data.people.push(person);
    state.currentPersonId = person.id;

    nameInput.value = "";
    roleInput.value = "";
    emailInput.value = "";
    phoneInput.value = "";
    notesInput.value = "";

    saveData();
    renderAll();
  });

  document.getElementById("export-data").addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(state.data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `attendance-data-${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(link);
    link.click();
    link.remove();
    URL.revokeObjectURL(url);
  });

  document.getElementById("import-data").addEventListener("change", (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const parsed = JSON.parse(reader.result);
        if (!parsed.people || !parsed.pointRules) throw new Error("Invalid format");
        state.data = parsed;
        saveData();
        renderAll();
      } catch (error) {
        alert("Import failed. Please choose a valid JSON export.");
      }
    };
    reader.readAsText(file);
  });

  document.getElementById("reset-data").addEventListener("click", () => {
    if (!confirm("Reset all data to defaults?")) return;
    state.data = defaultData();
    saveData();
    renderAll();
  });

  document.getElementById("apply-filter").addEventListener("click", () => {
    state.data.settings.filterFrom = document.getElementById("filter-from").value;
    state.data.settings.filterTo = document.getElementById("filter-to").value;
    saveData();
    renderAll();
  });

  document.getElementById("clear-filter").addEventListener("click", () => {
    state.data.settings.filterFrom = "";
    state.data.settings.filterTo = "";
    saveData();
    renderAll();
  });

  const unlocked = getSessionFlag(PIN_SESSION_KEY);
  if (unlocked) {
    unlockWithPin(ACCESS_PIN);
  } else {
    setLockState(true);
    pinInput.focus();
  }

  window.__appReady = true;
}

init();

</script>
  </body>
</html>
